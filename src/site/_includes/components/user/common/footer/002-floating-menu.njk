<aside id="floating-menu">
  <div class="floating-menu-container">
    <nav id="menu-items" class="menu-items hidden">
      <button id="recent-posts-btn" class="menu-item" title="Recently Read">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </button>
      <button id="graph-btn" class="menu-item" title="Graph">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="5" r="1"></circle>
          <circle cx="19" cy="12" r="1"></circle>
          <circle cx="12" cy="19" r="1"></circle>
          <circle cx="5" cy="12" r="1"></circle>
          <path d="M12 6v6m0 0v6m6-6h-6m0 0H6"></path>
        </svg>
      </button>
      <button id="theme-toggle" class="menu-item" title="Toggle Theme">
        <!-- Sun icon (light theme) -->
        <svg id="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <!-- Moon icon (dark theme) -->
        <svg id="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <a href="{{ '/' | url }}" class="menu-item" title="Home">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </a>
      <a href="https://github.com/beembarik/mydigitalgarden"
         target="_blank" rel="noopener"
         class="menu-item" title="GitHub">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
      </a>
    </nav>

    <button id="menu-toggle" class="menu-button main" title="Menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </div>

  <!-- RECENT MODAL -->
  <div id="recent-posts-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Recently Read</h2>
        <button class="close-btn" id="close-recent">&times;</button>
      </div>
      <div id="recent-posts-list" class="modal-body"></div>
    </div>
  </div>

  <!-- GRAPH MODAL -->
  <div id="graph-modal" class="modal hidden">
    <div class="modal-content graph-modal-content">
      <div class="modal-header">
        <h2>Global Graph</h2>
        <button class="close-btn" id="close-graph">&times;</button>
      </div>
      <div id="graph-container" class="modal-body graph-body"></div>
    </div>
  </div>
</aside>

<!-- graph libs: force-graph is included in page header (deferred) -->

<script>
(function() {
  const menuToggle = document.getElementById('menu-toggle');
  const menuItems = document.getElementById('menu-items');
  const themeToggle = document.getElementById('theme-toggle');
  const recentBtn = document.getElementById('recent-posts-btn');
  const graphBtn = document.getElementById('graph-btn');

  const recentModal = document.getElementById('recent-posts-modal');
  const graphModal = document.getElementById('graph-modal');

  const closeRecent = document.getElementById('close-recent');
  const closeGraph = document.getElementById('close-graph');

  let graphLoaded = false;

  // FUNCTION: Update theme icon based on current theme
  function updateThemeIcon() {
    const isDark = document.body.classList.contains('theme-dark');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    
    if (isDark) {
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    } else {
      sunIcon.style.display = 'block';
      moonIcon.style.display = 'none';
    }
  }

  // Initialize theme icon on page load
  updateThemeIcon();

  // MENU TOGGLE
  menuToggle.addEventListener('click', () => {
    menuItems.classList.toggle('hidden');
    menuToggle.classList.toggle('active');
    
    // Animate menu items on open
    if (!menuItems.classList.contains('hidden')) {
      const items = menuItems.querySelectorAll('.menu-item');
      items.forEach((item, index) => {
        item.style.animationDelay = `${index * 0.08}s`;
      });
    }
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('#floating-menu')) {
      menuItems.classList.add('hidden');
      menuToggle.classList.remove('active');
    }
  });

  // THEME
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('theme-dark');
    document.body.classList.toggle('theme-light');
    updateThemeIcon();
  });

  // RECENT MODAL
  recentBtn.addEventListener('click', () => {
    recentModal.classList.remove('hidden');
  });

  closeRecent.addEventListener('click', () => {
    recentModal.classList.add('hidden');
  });

  // GRAPH MODAL
  graphBtn.addEventListener('click', () => {
    graphModal.classList.remove('hidden');

    if (!graphLoaded) {
      setTimeout(initGraph, 100);
      graphLoaded = true;
    }
  });

  closeGraph.addEventListener('click', () => {
    graphModal.classList.add('hidden');
  });

  function initGraph() {
    const container = document.getElementById('graph-container');
    if (!container) {
      console.error('graph-container element not found');
      return;
    }

    container.innerHTML = '<div style="text-align:center;padding:2rem;"><p style="opacity:0.7;">Loading graph...</p></div>';

    // Check if ForceGraph is available
    if (typeof ForceGraph === 'undefined') {
      setTimeout(initGraph, 100);
      return;
    }

    // Wait for container to have dimensions
    const width = container.offsetWidth;
    const height = container.offsetHeight;
    if (width === 0 || height === 0) {
      setTimeout(initGraph, 100);
      return;
    }

    fetch('/graph.json')
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        // Handle both array and object formats for nodes
        let nodes = Array.isArray(data.nodes) ? data.nodes : Object.values(data.nodes || {});
        let links = data.links || [];

        if (!nodes || nodes.length === 0) {
          throw new Error('No graph nodes available');
        }

        // Ensure links reference node IDs properly
        const nodeIds = new Set(nodes.map(n => n.id));
        links = links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target));

        container.innerHTML = '';

        const el = document.createElement('div');
        el.style.width = '100%';
        el.style.height = '100%';
        container.appendChild(el);

        const nodeColor = getComputedStyle(document.documentElement).getPropertyValue('--text-accent').trim() || '#667eea';
        const linkColor = getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim() || '#999999';

        const graphData = { nodes: nodes, links: links };

        const Graph = ForceGraph()(el)
          .graphData(graphData)
          .nodeId('id')
          .nodeLabel('title')
          .linkSource('source')
          .linkTarget('target')
          .linkColor(() => linkColor)
          .onNodeClick(node => {
            if (node.url) window.location.href = node.url;
          });
      })
      .catch(err => {
        console.error('Graph error:', err);
        container.innerHTML =
          '<div style="text-align:center;padding:2rem;"><p style="opacity:0.7;">Graph data not available</p><p style="font-size:0.85rem;opacity:0.5;">Error: ' + err.message + '</p></div>';
      });
  }
})();
</script>